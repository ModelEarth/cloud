<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ACS + BLS Filter (Static UX)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:20px;}
    select,button{padding:6px 8px;margin-right:8px;}
    table{border-collapse:collapse;margin-top:16px;width:100%}
    th,td{border:1px solid #ddd;padding:6px;font-size:14px;}
    th{background:#f5f5f5;text-align:left}
    .muted{color:#666;font-size:13px;margin-top:6px}
  </style>
</head>
<body>
  <h1>ACS + BLS Filter (Static)</h1>

  <label>State: <select id="state"></select></label>
  <label>County: <select id="county"></select></label>
  <label>ZIP: <select id="zip"></select></label>
  <button id="run">Run</button>
  <span id="count" class="muted"></span>

  <div id="results"></div>

  <script>
    const stateSel = document.getElementById("state");
    const countySel = document.getElementById("county");
    const zipSel = document.getElementById("zip");
    const runBtn = document.getElementById("run");
    const resultsDiv = document.getElementById("results");
    const countDiv = document.getElementById("count");

    let DATA = [];
    let COLS = [];

    // Choose best column names from header variants
    function pickCol(header, candidates) {
      const map = {};
      header.forEach(h => map[h.toLowerCase()] = h);
      for (const c of candidates) {
        const k = c.toLowerCase();
        if (map[k]) return map[k];
      }
      return null;
    }

    function uniqNonEmpty(arr) {
      return Array.from(new Set(arr.filter(v => v !== "" && v != null)));
    }

    function setOptions(sel, items, placeholder) {
      sel.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = placeholder;
      sel.appendChild(opt);
      (items || []).forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        sel.appendChild(o);
      });
    }

    function normalize(s){ return (s ?? "").toString().trim().toLowerCase(); }

    function renderTable(rows){
      if (!rows || rows.length===0){
        resultsDiv.innerHTML = "<p>No rows found.</p>";
        countDiv.textContent = "0 rows";
        return;
      }
      const cols = Object.keys(rows[0]);
      let html = "<table><thead><tr>";
      cols.forEach(c => html += `<th>${c}</th>`);
      html += "</tr></thead><tbody>";
      rows.forEach(r => {
        html += "<tr>";
        cols.forEach(c => html += `<td>${r[c] ?? ""}</td>`);
        html += "</tr>";
      });
      html += "</tbody></table>";
      resultsDiv.innerHTML = html;
      countDiv.textContent = `${rows.length} row(s)`;
    }

    function populateFilters() {
      const stateCol  = pickCol(COLS, ["state","state_name","stusab","usps","st"]);
      const countyCol = pickCol(COLS, ["county","county_name","ctyname"]);
      const zipCol    = pickCol(COLS, ["zip","zipcode","zcta5","postal_code"]);

      const states = uniqNonEmpty(DATA.map(r => (r[stateCol] ?? "").toString().trim())).sort();
      setOptions(stateSel, states, "-- select state --");
      setOptions(countySel, [], "-- any --");
      setOptions(zipSel, [], "-- any --");

      stateSel.onchange = () => {
        const s = stateSel.value;
        const counties = uniqNonEmpty(
          DATA.filter(r => s === "" || r[stateCol] === s)
              .map(r => (r[countyCol] ?? "").toString().trim())
        ).sort();
        setOptions(countySel, counties, "-- any --");
        setOptions(zipSel, [], "-- any --");
      };

      countySel.onchange = () => {
        const s = stateSel.value, c = countySel.value;
        const zips = uniqNonEmpty(
          DATA.filter(r => (s === "" || r[stateCol]===s) && (c === "" || r[countyCol]===c))
              .map(r => (r[zipCol] ?? "").toString().trim())
        ).sort();
        setOptions(zipSel, zips, "-- any --");
      };

      runBtn.onclick = () => {
        const s = normalize(stateSel.value);
        const c = normalize(countySel.value);
        const z = (zipSel.value ?? "").toString().trim();
        const rows = DATA.filter(r => {
          const rs = normalize(r[stateCol]);
          const rc = normalize(r[countyCol]);
          const rz = (r[zipCol] ?? "").toString().trim();
          return (s==="" || rs===s) && (c==="" || rc===c) && (z==="" || rz===z);
        });
        renderTable(rows.slice(0, 1000));
      };
    }

    // Load CSV from the same folder's data/
    Papa.parse("./data/acs_bls_merged.csv", {
      download: true,
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: (res) => {
        DATA = res.data;
        COLS = res.meta.fields || Object.keys(DATA[0] || {});
        populateFilters();
      },
      error: (err) => {
        resultsDiv.innerHTML = "<p>Failed to load CSV: " + err + "</p>";
      }
    });
  </script>
</body>
</html>
